name: Terraform Drift Detection

on:
  schedule:
    - cron: '0 6 * * *'  # Run daily at 6 AM UTC
  workflow_dispatch:

env:
  TF_LOG: INFO
  AWS_REGION: ap-south-1

jobs:
  drift-detection:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment: [dev, staging, production]
    
    defaults:
      run:
        working-directory: environments/${{ matrix.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ vars.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      - name: Detect Drift
        id: drift
        run: |
          terraform plan -detailed-exitcode -no-color -input=false > plan_output.txt 2>&1 || echo "exit_code=$?" >> $GITHUB_OUTPUT
          cat plan_output.txt
        continue-on-error: true

      - name: Create Issue on Drift
        if: steps.drift.outputs.exit_code == '2'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('environments/${{ matrix.environment }}/plan_output.txt', 'utf8');
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Drift Detected: ${{ matrix.environment }}`,
              body: `## Infrastructure Drift Detected
              
              **Environment:** \`${{ matrix.environment }}\`
              **Detected at:** ${new Date().toISOString()}
              
              <details><summary>Terraform Plan Output</summary>
              
              \`\`\`
              ${planOutput.substring(0, 60000)}
              \`\`\`
              
              </details>
              
              Please review and reconcile the drift.`,
              labels: ['drift', 'infrastructure', '${{ matrix.environment }}']
            });

      - name: Cleanup
        if: always()
        run: rm -f plan_output.txt
